<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´ÙŠØª Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }
        
        .content {
            padding: 30px;
        }
        
        .sheet {
            display: none;
        }
        
        .sheet.active {
            display: block;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .input-group input, .input-group select {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .card .value {
            font-size: 28px;
            font-weight: bold;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: right;
            font-weight: bold;
            font-size: 14px;
        }
        
        td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #dee2e6;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody tr.highlight {
            background: #fff3cd;
            font-weight: bold;
        }
        
        .number {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .comparison-table {
            margin-top: 20px;
        }
        
        .savings {
            color: #28a745;
            font-weight: bold;
        }
        
        .additional {
            color: #dc3545;
            font-weight: bold;
        }
        
        .warning-message {
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            font-weight: bold;
            text-align: center;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .editable-cell input {
            width: 100%;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
            text-align: right;
        }
        
        .editable-cell input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Responsive Design */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 22px;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                font-size: 13px;
                padding: 12px 10px;
                white-space: nowrap;
                min-width: 100px;
            }
            
            .content {
                padding: 15px;
            }
            
            .input-section {
                padding: 15px;
            }
            
            .input-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .card h3 {
                font-size: 13px;
            }
            
            .card .value {
                font-size: 22px;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
                font-size: 13px;
            }
            
            th, td {
                padding: 10px 8px;
                font-size: 12px;
            }
            
            .editable-cell input {
                padding: 6px;
                font-size: 13px;
            }
            
            .btn {
                width: 100%;
                padding: 15px;
                font-size: 15px;
            }
            
            .warning-message {
                font-size: 13px;
                padding: 12px 15px;
            }
        }
        
        @media screen and (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }
            
            .header p {
                font-size: 12px;
            }
            
            .tab {
                font-size: 11px;
                padding: 10px 8px;
                min-width: 80px;
            }
            
            .content {
                padding: 10px;
            }
            
            .input-section {
                padding: 12px;
                margin-bottom: 20px;
            }
            
            .input-section h2 {
                font-size: 16px;
                margin-bottom: 15px;
            }
            
            .card {
                padding: 15px;
            }
            
            .card h3 {
                font-size: 12px;
            }
            
            .card .value {
                font-size: 20px;
            }
            
            table {
                min-width: 500px;
                font-size: 11px;
            }
            
            th, td {
                padding: 8px 6px;
                font-size: 11px;
            }
            
            .btn {
                font-size: 14px;
                padding: 12px;
            }
        }
        
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .input-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Ù†Ø¸Ø§Ù… Ø­Ø³Ø§Ø¨ Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©</h1>
            <p>Ø´ÙŠØª Ù…ØªÙƒØ§Ù…Ù„ Ù…Ø¹ ÙÙˆØ±Ù…ÙŠÙˆÙ„Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showSheet(1)">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</button>
            <button class="tab" onclick="showSheet(2)">Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</button>
            <button class="tab" onclick="showSheet(3)">Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø®ØµØµØ©</button>
            <button class="tab" onclick="showSheet(4)">Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª</button>
        </div>
        
        <div class="content">
            <!-- Sheet 1: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
            <div id="sheet1" class="sheet active">
                <div class="input-section">
                    <h2 style="margin-bottom: 20px; color: #495057;">ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¬Ù†ÙŠÙ‡)</label>
                            <input type="number" id="unitPrice" value="1000000" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label>Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ§Ø¦Ø¯Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© (%)</label>
                            <input type="number" id="interestRate" value="5" step="0.1" min="0" max="100" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…Ø¨ÙƒØ± Ø§Ù„Ø³Ù†ÙˆÙŠ (%)</label>
                            <input type="number" id="discountRate" value="3" step="0.1" min="0" max="100" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ø¯Ø§Ø¯</label>
                            <input type="date" id="startDate" oninput="calculate()">
                        </div>
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="card">
                        <h3>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</h3>
                        <div class="value" id="displayPrice">10,000,000 Ø¬.Ù…</div>
                    </div>
                    <div class="card">
                        <h3>Ø§Ù„Ù…Ù‚Ø¯Ù… (10%)</h3>
                        <div class="value" id="downPayment">1,000,000 Ø¬.Ù…</div>
                    </div>
                    <div class="card">
                        <h3>Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ù‚Ø¯Ù…</h3>
                        <div class="value" id="afterDown">9,000,000 Ø¬.Ù…</div>
                    </div>
                </div>
            </div>
            
            <!-- Sheet 2: Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© -->
            <div id="sheet2" class="sheet">
                <div class="input-section">
                    <h2 style="margin-bottom: 20px; color: #495057;">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†ÙŠÙ†</label>
                            <input type="number" id="defaultYears" value="6" min="1" max="15" oninput="calculate()">
                        </div>
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="card">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</h3>
                        <div class="value" id="defaultTotal">10,000,000 Ø¬.Ù…</div>
                        <small style="opacity: 0.8; font-size: 12px;">Ø«Ø§Ø¨Øª Ø¹Ù†Ø¯ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</small>
                    </div>
                    <div class="card">
                        <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</h3>
                        <div class="value" id="defaultInstallmentsCount">24 Ù‚Ø³Ø·</div>
                    </div>
                    <div class="card">
                        <h3>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</h3>
                        <div class="value" id="defaultDuration">6 Ø³Ù†ÙˆØ§Øª</div>
                    </div>
                </div>
                
                <div id="warningMessageDefault" class="warning-message">
                    âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø³Ø¨ ØªØ¬Ø§ÙˆØ² 100%! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
                </div>
                
                <div class="table-container">
                    <table id="defaultTable">
                        <thead>
                            <tr>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù‚Ø³Ø·</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù†Ø³Ø¨Ø© %</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…)</th>
                                <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø¬.Ù…)</th>
                            </tr>
                        </thead>
                        <tbody id="defaultTableBody">
                        </tbody>
                    </table>
                </div>
                
                <button class="btn" onclick="exportToExcel('default')">ğŸ“¥ ØªØµØ¯ÙŠØ± Ù„Ù…Ù„Ù Excel</button>
            </div>
            
            <!-- Sheet 3: Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø®ØµØµØ© -->
            <div id="sheet3" class="sheet">
                <div class="input-section">
                    <h2 style="margin-bottom: 20px; color: #495057;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø®ØµØµØ©</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†ÙŠÙ†</label>
                            <input type="number" id="customYears" value="6" min="1" max="15" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø©</label>
                            <select id="planType" onchange="calculate()">
                                <option value="custom">Ø®Ø·Ø© Ù…Ø®ØµØµØ©</option>
                                <option value="cash">Ø¯ÙØ¹ ÙƒØ§Ø´ (Ø®ØµÙ… 30%)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="card">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</h3>
                        <div class="value" id="customTotal">10,000,000 Ø¬.Ù…</div>
                    </div>
                    <div class="card">
                        <h3>Ø§Ù„ÙØ±Ù‚ Ø¹Ù† Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</h3>
                        <div class="value" id="customDiff">0 Ø¬.Ù…</div>
                    </div>
                    <div class="card">
                        <h3>Ù†ÙˆØ¹ Ø§Ù„ÙØ±Ù‚</h3>
                        <div class="value" id="customDiffType">-</div>
                    </div>
                </div>
                
                <div id="warningMessage" class="warning-message">
                    âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø³Ø¨ ØªØ¬Ø§ÙˆØ² 100%! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
                </div>
                
                <div id="customTableContainer" class="table-container" style="margin-top: 20px;">
                    <table id="customTable">
                        <thead>
                            <tr>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù‚Ø³Ø·</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù†Ø³Ø¨Ø© %</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…)</th>
                                <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø¬.Ù…)</th>
                            </tr>
                        </thead>
                        <tbody id="customTableBody">
                        </tbody>
                    </table>
                </div>
                
                <button class="btn" onclick="exportToExcel('custom')">ğŸ“¥ ØªØµØ¯ÙŠØ± Ù„Ù…Ù„Ù Excel</button>
            </div>
            
            <!-- Sheet 4: Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª -->
            <div id="sheet4" class="sheet">
                <h2 style="margin-bottom: 20px; color: #495057;">ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø®Ø·Ø·</h2>
                
                <div class="table-container comparison-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø©</th>
                                <th>Ø§Ù„Ù…Ø¯Ø©</th>
                                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…)</th>
                                <th>Ø§Ù„ÙØ±Ù‚ Ø¹Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                                <th>Ø§Ù„ØªÙˆÙÙŠØ±/Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
        document.getElementById('startDate').valueAsDate = new Date();
        
        // Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
        let manuallyEditedRows = new Set();
        let manuallyEditedDefaultRows = new Set();
        
        // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
        let savedDefaultValues = {};
        let savedCustomValues = {};
        
        // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©
        let actualDefaultTotal = 0;
        let actualCustomTotal = 0;
        
        function showSheet(num) {
            // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø´ÙŠØªØ§Øª
            document.querySelectorAll('.sheet').forEach(sheet => {
                sheet.classList.remove('active');
            });
            
            // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´ÙŠØª ÙˆØ§Ù„ØªØ§Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†
            document.getElementById('sheet' + num).classList.add('active');
            document.querySelectorAll('.tab')[num - 1].classList.add('active');
        }
        
        function formatCurrency(num) {
            return new Intl.NumberFormat('ar-EG').format(Math.round(num));
        }
        
        function formatDate(date) {
            return new Intl.DateTimeFormat('ar-EG', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).format(date);
        }
        
        function addMonths(date, months) {
            const result = new Date(date);
            result.setMonth(result.getMonth() + months);
            return result;
        }
        
        function calculate() {
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            let interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            let discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
            // Clamp rates to [0, 100]
            interestRate = Math.min(100, Math.max(0, interestRate));
            discountRate = Math.min(100, Math.max(0, discountRate));
            const startDate = new Date(document.getElementById('startDate').value);
            const customYears = parseFloat(document.getElementById('customYears').value) || 6;
            const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
            const planType = document.getElementById('planType').value;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            document.getElementById('displayPrice').textContent = formatCurrency(unitPrice) + ' Ø¬.Ù…';
            document.getElementById('downPayment').textContent = formatCurrency(unitPrice * 0.1) + ' Ø¬.Ù…';
            document.getElementById('afterDown').textContent = formatCurrency(unitPrice * 0.9) + ' Ø¬.Ù…';
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            calculateDefaultPlan(unitPrice, defaultYears, startDate);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø®ØµØµØ©
            if (planType === 'cash') {
                calculateCashPlan(unitPrice);
            } else {
                calculateCustomPlan(unitPrice, customYears, interestRate, discountRate, startDate);
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª
            updateComparison(unitPrice, defaultYears, customYears, interestRate, discountRate);
        }
        
        function calculateDefaultPlan(unitPrice, years, startDate) {
            const tbody = document.getElementById('defaultTableBody');
            const totalInstallments = years * 4;
            
            // ÙØ­Øµ Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ØªØ±Ø§Øª (Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†ÙŠÙ†)
            const planKey = `default_${years}`;
            if (!savedDefaultValues[planKey]) {
                // Ø®Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø© - Ù…Ø³Ø­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                manuallyEditedDefaultRows.clear();
                savedDefaultValues = {};
                savedDefaultValues[planKey] = {};
            }
            
            tbody.innerHTML = '';
            
            let remaining = unitPrice;
            let currentDate = new Date(startDate);
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ÙˆØ§Ù„Ù…Ø¯Ø©
            document.getElementById('defaultInstallmentsCount').textContent = totalInstallments + ' Ù‚Ø³Ø·';
            document.getElementById('defaultDuration').textContent = years + ' Ø³Ù†ÙˆØ§Øª';
            
            // Ø§Ù„Ù…Ù‚Ø¯Ù…
            const downPaymentPercentage = savedDefaultValues[planKey][0] || 10;
            const downPayment = unitPrice * (downPaymentPercentage / 100);
            remaining -= downPayment;
            tbody.innerHTML += `
                <tr class="highlight">
                    <td>0</td>
                    <td><strong>Ù…Ù‚Ø¯Ù…</strong></td>
                    <td>${formatDate(currentDate)}</td>
                    <td class="editable-cell">
                        <input type="number" step="0.01" min="0" max="100" value="${downPaymentPercentage.toFixed(2)}" 
                               onchange="saveAndUpdateDefaultInstallment(0, ${unitPrice}, '${planKey}')" 
                               data-row="0">
                    </td>
                    <td class="number">${formatCurrency(downPayment)}</td>
                    <td class="number">${formatCurrency(remaining)}</td>
                </tr>
            `;
            
            // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· - ØªÙˆØ²ÙŠØ¹ Ù…ØªØ³Ø§ÙˆÙŠ Ø£Ùˆ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            const remainingPercentage = 90; // 100% - 10% Ù…Ù‚Ø¯Ù…
            const installmentPercentage = remainingPercentage / totalInstallments;
            
            for (let i = 1; i <= totalInstallments; i++) {
                currentDate = addMonths(currentDate, 3);
                const percentage = savedDefaultValues[planKey][i] || installmentPercentage;
                const installmentAmount = unitPrice * (percentage / 100);
                remaining -= installmentAmount;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${i}</td>
                        <td>Ù‚Ø³Ø·</td>
                        <td>${formatDate(currentDate)}</td>
                        <td class="editable-cell">
                            <input type="number" step="0.01" min="0" max="100" value="${percentage.toFixed(2)}" 
                                   onchange="saveAndUpdateDefaultInstallment(${i}, ${unitPrice}, '${planKey}')" 
                                   data-row="${i}">
                        </td>
                        <td class="number">${formatCurrency(installmentAmount)}</td>
                        <td class="number">${formatCurrency(Math.max(0, remaining))}</td>
                    </tr>
                `;
            }
            
            // Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹ = Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø«Ø§Ø¨Øª)
            actualDefaultTotal = unitPrice;
            document.getElementById('defaultTotal').textContent = formatCurrency(unitPrice) + ' Ø¬.Ù…';
            
            validateDefaultTotalPercentage();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·Ø©
            setTimeout(() => {
                const customYears = parseFloat(document.getElementById('customYears').value) || 6;
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                updateComparison(unitPrice, years, customYears, interestRate, discountRate);
            }, 0);
        }
        
        function saveAndUpdateDefaultInstallment(rowIndex, total, planKey) {
            updateDefaultInstallment(rowIndex, total);
            
            // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
            const tbody = document.getElementById('defaultTableBody');
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row) => {
                const input = row.querySelector('input');
                if (input) {
                    const rowNum = parseInt(input.getAttribute('data-row'));
                    savedDefaultValues[planKey][rowNum] = parseFloat(input.value) || 0;
                }
            });
        }
        
        function updateDefaultInstallment(rowIndex, total) {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ø· Ù„Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
            manuallyEditedDefaultRows.add(rowIndex);
            
            const tbody = document.getElementById('defaultTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            // Ø¬Ù…Ø¹ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø«Ø¨ØªØ© (Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹)
            let fixedPercentages = 0;
            let flexibleRows = [];
            
            rows.forEach((row, index) => {
                const percentageInput = row.querySelector('input');
                const rowNum = parseInt(percentageInput.getAttribute('data-row'));
                
                if (manuallyEditedDefaultRows.has(rowNum)) {
                    // Ø£Ù‚Ø³Ø§Ø· Ù…Ø¹Ø¯Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ - Ù†Ø³Ø¨ Ø«Ø§Ø¨ØªØ©
                    fixedPercentages += parseFloat(percentageInput.value) || 0;
                } else {
                    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· - Ø³ØªØªÙˆØ²Ø¹ Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
                    flexibleRows.push(row);
                }
            });
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„ØªÙˆØ²ÙŠØ¹
            const remainingPercentage = 100 - fixedPercentages;
            
            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø±Ù†Ø©
            if (flexibleRows.length > 0) {
                if (remainingPercentage >= 0) {
                    const percentagePerInstallment = remainingPercentage / flexibleRows.length;
                    
                    flexibleRows.forEach(row => {
                        const percentageInput = row.querySelector('input');
                        percentageInput.value = percentagePerInstallment.toFixed(2);
                    });
                } else {
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ±
                    document.getElementById('warningMessageDefault').style.display = 'block';
                    document.getElementById('warningMessageDefault').textContent = 
                        `âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© ØªØ¬Ø§ÙˆØ²Øª 100%! ÙŠØ±Ø¬Ù‰ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù†Ø³Ø¨`;
                }
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
            let remaining = total;
            
            rows.forEach((row, index) => {
                const percentageInput = row.querySelector('input');
                const percentage = parseFloat(percentageInput.value) || 0;
                const amount = total * (percentage / 100);
                
                remaining -= amount;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº
                const amountCell = row.querySelectorAll('td')[4];
                amountCell.innerHTML = formatCurrency(amount);
                amountCell.classList.add('number');
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
                const remainingCell = row.querySelectorAll('td')[5];
                remainingCell.innerHTML = formatCurrency(Math.max(0, remaining));
                remainingCell.classList.add('number');
            });
            
            validateDefaultTotalPercentage();
            updateDefaultTotal(total);
            
            // Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
            const planKey = `default_${defaultYears}`;
            rows.forEach((row) => {
                const input = row.querySelector('input');
                if (input) {
                    const rowNum = parseInt(input.getAttribute('data-row'));
                    savedDefaultValues[planKey][rowNum] = parseFloat(input.value) || 0;
                }
            });
        }
        
        function validateDefaultTotalPercentage() {
            const tbody = document.getElementById('defaultTableBody');
            const inputs = tbody.querySelectorAll('input[type="number"]');
            
            let totalPercentage = 0;
            inputs.forEach(input => {
                totalPercentage += parseFloat(input.value) || 0;
            });
            
            const warningMessage = document.getElementById('warningMessageDefault');
            if (Math.abs(totalPercentage - 100) > 0.1) {
                if (totalPercentage > 100) {
                    warningMessage.style.display = 'block';
                    warningMessage.textContent = `âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø³Ø¨ ${totalPercentage.toFixed(2)}% ØªØ¬Ø§ÙˆØ² 100%!`;
                } else {
                    warningMessage.style.display = 'block';
                    warningMessage.textContent = `â„¹ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø³Ø¨ ${totalPercentage.toFixed(2)}% - Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø«Ø§Ø¨Øª Ø¹Ù†Ø¯ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©`;
                    warningMessage.style.background = '#17a2b8';
                }
            } else {
                warningMessage.style.display = 'none';
            }
            
            return totalPercentage;
        }
        
        function updateDefaultTotal(baseTotal) {
            validateDefaultTotalPercentage();
            
            // Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹ = Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø«Ø§Ø¨Øª)
            actualDefaultTotal = baseTotal;
            document.getElementById('defaultTotal').textContent = formatCurrency(actualDefaultTotal) + ' Ø¬.Ù…';
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            try {
                const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
                const customYears = parseFloat(document.getElementById('customYears').value) || 6;
                const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
                const startDate = new Date(document.getElementById('startDate').value);
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø®ØµØµØ©
                const customYearsVal = parseFloat(document.getElementById('customYears').value) || 6;
                const yearsDiff = customYearsVal - defaultYears;
                let customBaseTotal = unitPrice;
                
                if (yearsDiff > 0) {
                    const r = (interestRate || 0) / 100;
                    customBaseTotal = unitPrice * Math.pow(1 + r, yearsDiff);
                } else if (yearsDiff < 0) {
                    const d = (discountRate || 0) / 100;
                    customBaseTotal = unitPrice / Math.pow(1 + d, Math.abs(yearsDiff));
                }
                
                const defaultFlows = buildDefaultPlanFlowsFromTable(defaultYears, startDate);
                const customFlows = buildCustomPlanFlowsFromTable(customYearsVal, startDate);
                const timingAdjustment = computeTimingAdjustment(unitPrice, defaultFlows, customFlows, interestRate, discountRate);
                
                actualCustomTotal = customBaseTotal + timingAdjustment;
                document.getElementById('customTotal').textContent = formatCurrency(actualCustomTotal) + ' Ø¬.Ù…';
                
                const diff = actualCustomTotal - actualDefaultTotal;
                document.getElementById('customDiff').textContent = formatCurrency(Math.abs(diff)) + ' Ø¬.Ù…';
                if (diff > 0) {
                    document.getElementById('customDiffType').textContent = 'Ø²ÙŠØ§Ø¯Ø© Ø¹Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©';
                    document.getElementById('customDiffType').style.color = '#dc3545';
                } else if (diff < 0) {
                    document.getElementById('customDiffType').textContent = 'ØªÙˆÙÙŠØ± Ø¹Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©';
                    document.getElementById('customDiffType').style.color = '#28a745';
                } else {
                    document.getElementById('customDiffType').textContent = 'Ù†ÙØ³ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©';
                    document.getElementById('customDiffType').style.color = '#667eea';
                }
            } catch (e) {
                console.warn('Custom plan update skipped:', e);
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            setTimeout(() => {
                const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
                const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
                const customYears = parseFloat(document.getElementById('customYears').value) || 6;
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                updateComparison(unitPrice, defaultYears, customYears, interestRate, discountRate);
            }, 0);
        }
        
        function calculateCashPlan(unitPrice) {
            const cashAmount = unitPrice * 0.7;
            actualCustomTotal = cashAmount;
            document.getElementById('customTotal').textContent = formatCurrency(cashAmount) + ' Ø¬.Ù…';
            
            const diff = cashAmount - actualDefaultTotal;
            document.getElementById('customDiff').textContent = formatCurrency(Math.abs(diff)) + ' Ø¬.Ù…';
            document.getElementById('customDiffType').textContent = 'ØªÙˆÙÙŠØ± (Ø®ØµÙ… 30%)';
            document.getElementById('customDiffType').style.color = '#28a745';
            
            const tbody = document.getElementById('customTableBody');
            tbody.innerHTML = `
                <tr class="highlight">
                    <td>0</td>
                    <td>${formatDate(new Date())}</td>
                    <td>70.00%</td>
                    <td class="number">${formatCurrency(cashAmount)}</td>
                    <td class="number">0</td>
                </tr>
            `;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± Ù„Ù„Ø¯ÙØ¹ Ø§Ù„ÙƒØ§Ø´
            document.getElementById('warningMessage').style.display = 'none';
            document.getElementById('customTableContainer').style.display = 'block';
        }
        
        function calculateCustomPlan(unitPrice, customYears, interestRate, discountRate, startDate) {
            const totalInstallments = customYears * 4;
            
            // ÙØ­Øµ Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ØªØ±Ø§Øª
            const planKey = `custom_${customYears}`;
            if (!savedCustomValues[planKey]) {
                // Ø®Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø© - Ù…Ø³Ø­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                manuallyEditedRows.clear();
                savedCustomValues = {};
                savedCustomValues[planKey] = {};
            }
            
            // Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø¹Ø¯Ø¯ Ø³Ù†ÙŠÙ† Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
            const yearsDiff = customYears - defaultYears;
            let total = unitPrice;
            let diffAmount = 0;
            let diffType = '';
            
            if (yearsDiff > 0) {
                // ÙÙˆØ§Ø¦Ø¯ Ù…Ø±ÙƒØ¨Ø© Ø³Ù†ÙˆÙŠØ©: Ø¥Ø¬Ù…Ø§Ù„ÙŠ = Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ * (1 + r)^n
                const r = (interestRate || 0) / 100;
                total = unitPrice * Math.pow(1 + r, yearsDiff);
                diffAmount = total - unitPrice;
                diffType = `ÙÙˆØ§Ø¦Ø¯ Ù…Ø±ÙƒØ¨Ø© (${yearsDiff} Ø³Ù†Ø© Ø¥Ø¶Ø§ÙÙŠØ©)`;
                document.getElementById('customDiffType').style.color = '#dc3545';
            } else if (yearsDiff < 0) {
                // Ø®ØµÙ… Ù…Ø±ÙƒØ¨ Ø³Ù†ÙˆÙŠ: Ø¥Ø¬Ù…Ø§Ù„ÙŠ = Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ / (1 + d)^n
                const d = (discountRate || 0) / 100;
                total = unitPrice / Math.pow(1 + d, Math.abs(yearsDiff));
                diffAmount = unitPrice - total;
                diffType = `Ø®ØµÙ… Ù…Ø±ÙƒØ¨ (${Math.abs(yearsDiff)} Ø³Ù†Ø© Ù…Ø¨ÙƒØ±Ø©)`;
                document.getElementById('customDiffType').style.color = '#28a745';
            } else {
                diffType = 'Ù†ÙØ³ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©';
                document.getElementById('customDiffType').style.color = '#667eea';
            }
            
            actualCustomTotal = total;
            document.getElementById('customTotal').textContent = formatCurrency(total) + ' Ø¬.Ù…';
            
            // Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const actualDiff = actualCustomTotal - actualDefaultTotal;
            
            document.getElementById('customDiff').textContent = formatCurrency(Math.abs(actualDiff)) + ' Ø¬.Ù…';
            
            if (actualDiff > 0) {
                document.getElementById('customDiffType').textContent = 'Ø²ÙŠØ§Ø¯Ø© Ø¹Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©';
                document.getElementById('customDiffType').style.color = '#dc3545';
            } else if (actualDiff < 0) {
                document.getElementById('customDiffType').textContent = 'ØªÙˆÙÙŠØ± Ø¹Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©';
                document.getElementById('customDiffType').style.color = '#28a745';
            } else {
                document.getElementById('customDiffType').textContent = 'Ù†ÙØ³ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©';
                document.getElementById('customDiffType').style.color = '#667eea';
            }
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
            const tbody = document.getElementById('customTableBody');
            tbody.innerHTML = '';
            
            let remaining = total;
            let currentDate = new Date(startDate);
            
            // Ø§Ù„Ù…Ù‚Ø¯Ù… - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø£Ùˆ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (10%)
            const downPercent = (savedCustomValues[planKey] && savedCustomValues[planKey][0] != null)
                ? (parseFloat(savedCustomValues[planKey][0]) || 10) : 10;
            
            const downPayment = total * (downPercent / 100);
            remaining -= downPayment;
            tbody.innerHTML += `
                <tr class="highlight">
                    <td>0</td>
                    <td>${formatDate(currentDate)}</td>
                    <td class="editable-cell">
                        <input type="number" step="0.01" min="0" max="100" value="${downPercent.toFixed(2)}" 
                               onchange="saveAndUpdateInstallment(0, ${total}, '${planKey}')" 
                               data-row="0">
                    </td>
                    <td class="number">${formatCurrency(downPayment)}</td>
                    <td class="number">${formatCurrency(remaining)}</td>
                </tr>
            `;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†ÙŠÙ† - ØªÙˆØ²ÙŠØ¹ Ù…ØªØ³Ø§ÙˆÙŠ Ù„Ù„Ø¨Ø§Ù‚ÙŠ
            const remainingPercent = 100 - downPercent;
            const installmentPercent = remainingPercent / totalInstallments;
            
            for (let i = 1; i <= totalInstallments; i++) {
                currentDate = addMonths(currentDate, 3);
                const percentage = (savedCustomValues[planKey] && savedCustomValues[planKey][i] != null)
                    ? (parseFloat(savedCustomValues[planKey][i]) || 0)
                    : installmentPercent;
                const amount = total * (percentage / 100);
                remaining -= amount;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${i}</td>
                        <td>${formatDate(currentDate)}</td>
                        <td class="editable-cell">
                            <input type="number" step="0.01" min="0" max="100" value="${percentage.toFixed(2)}" 
                                   onchange="saveAndUpdateInstallment(${i}, ${total}, '${planKey}')" 
                                   data-row="${i}">
                        </td>
                        <td class="number">${formatCurrency(amount)}</td>
                        <td class="number">${formatCurrency(Math.max(0, remaining))}</td>
                    </tr>
                `;
            }
            
            document.getElementById('customTableContainer').style.display = 'block';
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø®ØµÙ…/ÙÙˆØ§Ø¦Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªÙ‚Ø¯ÙŠÙ…/ØªØ£Ø®ÙŠØ± Ø§Ù„Ø³Ø¯Ø§Ø¯ Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            try {
                // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§
                const defaultFlows = buildDefaultPlanFlowsFromTable(defaultYears, startDate);
                const customFlows = buildCustomPlanFlowsFromTable(customYears, startDate);
                const timingAdjustment = computeTimingAdjustment(unitPrice, defaultFlows, customFlows, interestRate, discountRate);

                actualCustomTotal = total + timingAdjustment;
                document.getElementById('customTotal').textContent = formatCurrency(actualCustomTotal) + ' Ø¬.Ù…';

                const updatedDiff = actualCustomTotal - actualDefaultTotal;
                document.getElementById('customDiff').textContent = formatCurrency(Math.abs(updatedDiff)) + ' Ø¬.Ù…';
                if (updatedDiff > 0) {
                    document.getElementById('customDiffType').textContent = 'Ø²ÙŠØ§Ø¯Ø© Ø¹Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©';
                    document.getElementById('customDiffType').style.color = '#dc3545';
                } else if (updatedDiff < 0) {
                    document.getElementById('customDiffType').textContent = 'ØªÙˆÙÙŠØ± Ø¹Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©';
                    document.getElementById('customDiffType').style.color = '#28a745';
                } else {
                    document.getElementById('customDiffType').textContent = 'Ù†ÙØ³ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©';
                    document.getElementById('customDiffType').style.color = '#667eea';
                }
            } catch (e) {
                console.warn('Timing adjustment skipped:', e);
            }
            
            validateTotalPercentage();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·Ø©
            setTimeout(() => {
                const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                updateComparison(unitPrice, defaultYears, customYears, interestRate, discountRate);
            }, 0);
        }

        // ÙŠØ¨Ù†ÙŠ ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ: Ù…ØµÙÙˆÙØ© Ù…Ù† { date, percent }
        function buildDefaultPlanFlowsFromTable(years, startDate) {
            const flows = [];
            const tbody = document.getElementById('defaultTableBody');
            const rows = tbody.querySelectorAll('tr');
            let currentDate = new Date(startDate);
            
            rows.forEach((row, index) => {
                const input = row.querySelector('input[type="number"]');
                if (input) {
                    const percent = parseFloat(input.value) || 0;
                    flows.push({ date: new Date(currentDate), percent: percent });
                    // ÙƒÙ„ Ù‚Ø³Ø· Ø¨Ø¹Ø¯ 3 Ø£Ø´Ù‡Ø±
                    if (index < rows.length - 1) {
                        currentDate = addMonths(currentDate, 3);
                    }
                }
            });
            
            return flows;
        }

        // ÙŠØ¨Ù†ÙŠ ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ: Ù…ØµÙÙˆÙØ© Ù…Ù† { date, percent }
        function buildCustomPlanFlowsFromTable(years, startDate) {
            const flows = [];
            const tbody = document.getElementById('customTableBody');
            const rows = tbody.querySelectorAll('tr');
            let currentDate = new Date(startDate);
            
            rows.forEach((row, index) => {
                const input = row.querySelector('input[type="number"]');
                if (input) {
                    const percent = parseFloat(input.value) || 0;
                    flows.push({ date: new Date(currentDate), percent: percent });
                    // ÙƒÙ„ Ù‚Ø³Ø· Ø¨Ø¹Ø¯ 3 Ø£Ø´Ù‡Ø±
                    if (index < rows.length - 1) {
                        currentDate = addMonths(currentDate, 3);
                    }
                }
            });
            
            return flows;
        }

        // ÙŠØ­Ø³Ø¨ ÙØ±Ù‚ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©: Ø®ØµÙ… Ù„Ù„ØªÙ‚Ø¯ÙŠÙ… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… discountRateØŒ ÙˆÙÙˆØ§Ø¦Ø¯ Ù„Ù„ØªØ£Ø®ÙŠØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… interestRate
        function computeTimingAdjustment(unitPrice, defaultFlows, customFlows, interestRate, discountRate) {
            let i = 0, j = 0;
            let remDef = defaultFlows.length ? (defaultFlows[0].percent || 0) : 0;
            let remCus = customFlows.length ? (customFlows[0].percent || 0) : 0;
            let adjustment = 0; // Ù…ÙˆØ¬Ø¨ = Ø²ÙŠØ§Ø¯Ø©ØŒ Ø³Ø§Ù„Ø¨ = Ø®ØµÙ…
            const r = Math.max(0, (interestRate || 0) / 100);
            const d = Math.max(0, (discountRate || 0) / 100);

            const toYears = (from, to) => Math.max(0, (to.getTime() - from.getTime()) / (365.25 * 24 * 3600 * 1000));

            while (i < defaultFlows.length && j < customFlows.length) {
                const def = defaultFlows[i];
                const cus = customFlows[j];
                const move = Math.min(remDef, remCus);

                if (move > 0) {
                    if (cus.date < def.date) {
                        // ØªÙ‚Ø¯ÙŠÙ… Ø³Ø¯Ø§Ø¯: Ø®ØµÙ…
                        const t = toYears(cus.date, def.date);
                        const discount = unitPrice * (move / 100) * (1 - 1 / Math.pow(1 + d, t));
                        adjustment -= discount;
                    } else if (cus.date > def.date) {
                        // ØªØ£Ø®ÙŠØ± Ø³Ø¯Ø§Ø¯: ÙÙˆØ§Ø¦Ø¯
                        const t = toYears(def.date, cus.date);
                        const surcharge = unitPrice * (move / 100) * (Math.pow(1 + r, t) - 1);
                        adjustment += surcharge;
                    }
                }

                remDef -= move;
                remCus -= move;
                if (remDef <= 1e-9) {
                    i++;
                    remDef = i < defaultFlows.length ? (defaultFlows[i].percent || 0) : 0;
                }
                if (remCus <= 1e-9) {
                    j++;
                    remCus = j < customFlows.length ? (customFlows[j].percent || 0) : 0;
                }
            }

            return adjustment;
        }
        
        function saveAndUpdateInstallment(rowIndex, total, planKey) {
            updateInstallment(rowIndex, total);
            
            // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
            const tbody = document.getElementById('customTableBody');
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row) => {
                const input = row.querySelector('input');
                if (input) {
                    const rowNum = parseInt(input.getAttribute('data-row'));
                    savedCustomValues[planKey][rowNum] = parseFloat(input.value) || 0;
                }
            });
        }
        
        function updateInstallment(rowIndex, total) {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ø· Ù„Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
            manuallyEditedRows.add(rowIndex);
            
            const tbody = document.getElementById('customTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            // Ø¬Ù…Ø¹ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø«Ø¨ØªØ© (Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹)
            let fixedPercentages = 0;
            let flexibleRows = [];
            
            rows.forEach((row, index) => {
                const percentageInput = row.querySelector('input');
                const rowNum = parseInt(percentageInput.getAttribute('data-row'));
                
                if (manuallyEditedRows.has(rowNum)) {
                    // Ø£Ù‚Ø³Ø§Ø· Ù…Ø¹Ø¯Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ - Ù†Ø³Ø¨ Ø«Ø§Ø¨ØªØ©
                    fixedPercentages += parseFloat(percentageInput.value) || 0;
                } else {
                    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· - Ø³ØªØªÙˆØ²Ø¹ Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
                    flexibleRows.push(row);
                }
            });
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„ØªÙˆØ²ÙŠØ¹
            const remainingPercentage = 100 - fixedPercentages;
            
            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø±Ù†Ø©
            if (flexibleRows.length > 0) {
                if (remainingPercentage >= 0) {
                    const percentagePerInstallment = remainingPercentage / flexibleRows.length;
                    
                    flexibleRows.forEach(row => {
                        const percentageInput = row.querySelector('input');
                        percentageInput.value = percentagePerInstallment.toFixed(2);
                    });
                } else {
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ±
                    document.getElementById('warningMessage').style.display = 'block';
                    document.getElementById('warningMessage').textContent = 
                        `âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© ØªØ¬Ø§ÙˆØ²Øª 100%! ÙŠØ±Ø¬Ù‰ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù†Ø³Ø¨`;
                }
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
            let remaining = total;
            
            rows.forEach((row, index) => {
                const percentageInput = row.querySelector('input');
                const percentage = parseFloat(percentageInput.value) || 0;
                const amount = total * (percentage / 100);
                
                remaining -= amount;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº
                const amountCell = row.querySelectorAll('td')[3];
                amountCell.innerHTML = formatCurrency(amount);
                amountCell.classList.add('number');
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
                const remainingCell = row.querySelectorAll('td')[4];
                remainingCell.innerHTML = formatCurrency(Math.max(0, remaining));
                remainingCell.classList.add('number');
            });
            
            validateTotalPercentage();
            updateCustomTotal(total);
            
            // Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            const customYears = parseFloat(document.getElementById('customYears').value) || 6;
            const planKey = `custom_${customYears}`;
            rows.forEach((row) => {
                const input = row.querySelector('input');
                if (input) {
                    const rowNum = parseInt(input.getAttribute('data-row'));
                    savedCustomValues[planKey][rowNum] = parseFloat(input.value) || 0;
                }
            });
        }
        
        function validateTotalPercentage() {
            const tbody = document.getElementById('customTableBody');
            const inputs = tbody.querySelectorAll('input[type="number"]');
            
            let totalPercentage = 0;
            inputs.forEach(input => {
                totalPercentage += parseFloat(input.value) || 0;
            });
            
            // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            const warningMessage = document.getElementById('warningMessage');
            if (Math.abs(totalPercentage - 100) > 0.1 && totalPercentage > 100) {
                // Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø³Ø¨Ø© Ø£ÙƒØ¨Ø± Ù…Ù† 100 Ø¨Ø´ÙƒÙ„ Ù…Ù„Ø­ÙˆØ¸
                warningMessage.style.display = 'block';
                warningMessage.textContent = `âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø³Ø¨ ${totalPercentage.toFixed(2)}% ØªØ¬Ø§ÙˆØ² 100%!`;
            } else {
                warningMessage.style.display = 'none';
            }
            
            return totalPercentage;
        }
        
        function updateCustomTotal(baseTotal) {
            const totalPercentage = validateTotalPercentage();
            let calculatedTotal = baseTotal * (totalPercentage / 100);
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ timing adjustment Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
            try {
                const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
                const customYears = parseFloat(document.getElementById('customYears').value) || 6;
                const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
                const startDate = new Date(document.getElementById('startDate').value);
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                
                const defaultFlows = buildDefaultPlanFlowsFromTable(defaultYears, startDate);
                const customFlows = buildCustomPlanFlowsFromTable(customYears, startDate);
                const timingAdjustment = computeTimingAdjustment(unitPrice, defaultFlows, customFlows, interestRate, discountRate);
                
                actualCustomTotal = calculatedTotal + timingAdjustment;
            } catch (e) {
                console.warn('Timing adjustment skipped in updateCustomTotal:', e);
                actualCustomTotal = calculatedTotal;
            }
            
            document.getElementById('customTotal').textContent = formatCurrency(actualCustomTotal) + ' Ø¬.Ù…';
            
            // Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const diff = actualCustomTotal - actualDefaultTotal;
            
            document.getElementById('customDiff').textContent = formatCurrency(Math.abs(diff)) + ' Ø¬.Ù…';
            
            if (diff > 0) {
                document.getElementById('customDiffType').textContent = 'Ø²ÙŠØ§Ø¯Ø©';
                document.getElementById('customDiffType').style.color = '#dc3545';
            } else if (diff < 0) {
                document.getElementById('customDiffType').textContent = 'ØªÙˆÙÙŠØ±';
                document.getElementById('customDiffType').style.color = '#28a745';
            } else {
                document.getElementById('customDiffType').textContent = 'Ù†ÙØ³ Ø§Ù„Ø³Ø¹Ø±';
                document.getElementById('customDiffType').style.color = '#667eea';
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª
            setTimeout(() => {
                const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
                const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
                const customYears = parseFloat(document.getElementById('customYears').value) || 6;
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                updateComparison(unitPrice, defaultYears, customYears, interestRate, discountRate);
            }, 0);
        }
        
        function updateComparison(unitPrice, defaultYears, customYears, interestRate, discountRate) {
            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø©
            const defaultTotal = actualDefaultTotal || unitPrice;
            const customTotal = actualCustomTotal || unitPrice;
            
            // Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const defaultInstallments = defaultYears * 4;
            tbody.innerHTML += `
                <tr>
                    <td><strong>Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</strong></td>
                    <td>${defaultYears} Ø³Ù†Ø© (${defaultInstallments} Ù‚Ø³Ø·)</td>
                    <td class="number">${formatCurrency(defaultTotal)}</td>
                    <td class="number">-</td>
                    <td>Ø®Ø·Ø© Ø£Ø³Ø§Ø³ÙŠØ©</td>
                </tr>
            `;
            
            // Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø®ØµØµØ©
            const customInstallments = customYears * 4;
            const diff = customTotal - defaultTotal;
            let diffText = '';
            let savingsClass = '';
            let diffType = '';
            
            if (diff > 0) {
                diffText = `+${formatCurrency(diff)}`;
                savingsClass = 'additional';
                diffType = 'Ø²ÙŠØ§Ø¯Ø©';
            } else if (diff < 0) {
                diffText = `-${formatCurrency(Math.abs(diff))}`;
                savingsClass = 'savings';
                diffType = 'ØªÙˆÙÙŠØ±';
            } else {
                diffText = '0';
                diffType = 'Ù†ÙØ³ Ø§Ù„Ù…Ø¨Ù„Øº';
            }
            
            tbody.innerHTML += `
                <tr>
                    <td><strong>Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø®ØµØµØ©</strong></td>
                    <td>${customYears} Ø³Ù†Ø© (${customInstallments} Ù‚Ø³Ø·)</td>
                    <td class="number">${formatCurrency(customTotal)}</td>
                    <td class="number ${savingsClass}">${diffText}</td>
                    <td>${diffType}</td>
                </tr>
            `;
            
            // Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ÙƒØ§Ø´
            const cashTotal = unitPrice * 0.7;
            const cashDiff = cashTotal - defaultTotal;
            const cashDiffText = cashDiff < 0 ? `-${formatCurrency(Math.abs(cashDiff))}` : `+${formatCurrency(cashDiff)}`;
            tbody.innerHTML += `
                <tr>
                    <td><strong>Ø¯ÙØ¹ ÙƒØ§Ø´</strong></td>
                    <td>Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©</td>
                    <td class="number">${formatCurrency(cashTotal)}</td>
                    <td class="number savings">${cashDiffText}</td>
                    <td>Ø®ØµÙ… 30% Ù…Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</td>
                </tr>
            `;
        }
        
        function exportToExcel(type) {
            let csv = '\ufeff'; // BOM for UTF-8
            
            if (type === 'default') {
                csv += 'Ø±Ù‚Ù… Ø§Ù„Ù‚Ø³Ø·,Ø§Ù„Ù†ÙˆØ¹,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ù†Ø³Ø¨Ø© %,Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…),Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø¬.Ù…)\n';
                const tbody = document.getElementById('defaultTableBody');
                const rows = tbody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const cols = row.querySelectorAll('td');
                    const rowData = [];
                    cols.forEach((col, index) => {
                        // Ù„Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø§Ø¨Ø¹ (Ø§Ù„Ù†Ø³Ø¨Ø©) Ù†Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ù€ input
                        if (index === 3) {
                            const input = col.querySelector('input');
                            if (input) {
                                rowData.push(input.value + '%');
                            } else {
                                rowData.push(col.textContent.trim());
                            }
                        } else {
                            rowData.push(col.textContent.trim());
                        }
                    });
                    csv += rowData.join(',') + '\n';
                });
            } else if (type === 'custom') {
                csv += 'Ø±Ù‚Ù… Ø§Ù„Ù‚Ø³Ø·,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ù†Ø³Ø¨Ø© %,Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…),Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø¬.Ù…)\n';
                const tbody = document.getElementById('customTableBody');
                const rows = tbody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const cols = row.querySelectorAll('td');
                    const rowData = [];
                    cols.forEach((col, index) => {
                        // Ù„Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù„Ø« (Ø§Ù„Ù†Ø³Ø¨Ø©) Ù†Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ù€ input
                        if (index === 2) {
                            const input = col.querySelector('input');
                            if (input) {
                                rowData.push(input.value + '%');
                            } else {
                                rowData.push(col.textContent.trim());
                            }
                        } else {
                            rowData.push(col.textContent.trim());
                        }
                    });
                    csv += rowData.join(',') + '\n';
                });
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `payment_plan_${type}_${Date.now()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙŠ
        calculate();
    </script>
</body>
</html>
