<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شيت حساب الأقساط</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }
        
        .content {
            padding: 30px;
        }
        
        .sheet {
            display: none;
        }
        
        .sheet.active {
            display: block;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .input-group input, .input-group select {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .card .value {
            font-size: 28px;
            font-weight: bold;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: right;
            font-weight: bold;
            font-size: 14px;
        }
        
        td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #dee2e6;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody tr.highlight {
            background: #fff3cd;
            font-weight: bold;
        }
        
        .number {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .comparison-table {
            margin-top: 20px;
        }
        
        .savings {
            color: #28a745;
            font-weight: bold;
        }
        
        .additional {
            color: #dc3545;
            font-weight: bold;
        }
        
        .warning-message {
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            font-weight: bold;
            text-align: center;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .editable-cell input {
            width: 100%;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
            text-align: right;
        }
        
        .editable-cell input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Responsive Design */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 22px;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                font-size: 13px;
                padding: 12px 10px;
                white-space: nowrap;
                min-width: 100px;
            }
            
            .content {
                padding: 15px;
            }
            
            .input-section {
                padding: 15px;
            }
            
            .input-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .card h3 {
                font-size: 13px;
            }
            
            .card .value {
                font-size: 22px;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
                font-size: 13px;
            }
            
            th, td {
                padding: 10px 8px;
                font-size: 12px;
            }
            
            .editable-cell input {
                padding: 6px;
                font-size: 13px;
            }
            
            .btn {
                width: 100%;
                padding: 15px;
                font-size: 15px;
            }
            
            .warning-message {
                font-size: 13px;
                padding: 12px 15px;
            }
        }
        
        @media screen and (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }
            
            .header p {
                font-size: 12px;
            }
            
            .tab {
                font-size: 11px;
                padding: 10px 8px;
                min-width: 80px;
            }
            
            .content {
                padding: 10px;
            }
            
            .input-section {
                padding: 12px;
                margin-bottom: 20px;
            }
            
            .input-section h2 {
                font-size: 16px;
                margin-bottom: 15px;
            }
            
            .card {
                padding: 15px;
            }
            
            .card h3 {
                font-size: 12px;
            }
            
            .card .value {
                font-size: 20px;
            }
            
            table {
                min-width: 500px;
                font-size: 11px;
            }
            
            th, td {
                padding: 8px 6px;
                font-size: 11px;
            }
            
            .btn {
                font-size: 14px;
                padding: 12px;
            }
        }
        
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .input-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 نظام حساب أقساط الوحدات العقارية</h1>
            <p>شيت متكامل مع فورميولات تلقائية</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showSheet(1)">البيانات الأساسية</button>
            <button class="tab" onclick="showSheet(2)">الخطة الافتراضية</button>
            <button class="tab" onclick="showSheet(3)">الخطة المخصصة</button>
            <button class="tab" onclick="showSheet(4)">المقارنات</button>
        </div>
        
        <div class="content">
            <!-- Sheet 1: البيانات الأساسية -->
            <div id="sheet1" class="sheet active">
                <div class="input-section">
                    <h2 style="margin-bottom: 20px; color: #495057;">📝 إدخال البيانات الأساسية</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>سعر الوحدة (جنيه)</label>
                            <input type="number" id="unitPrice" value="1000000" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label>نسبة الفائدة السنوية (%)</label>
                            <input type="number" id="interestRate" value="5" step="0.1" min="0" max="100" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label>نسبة الخصم المبكر السنوي (%)</label>
                            <input type="number" id="discountRate" value="3" step="0.1" min="0" max="100" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label>تاريخ بداية السداد</label>
                            <input type="date" id="startDate" oninput="calculate()">
                        </div>
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="card">
                        <h3>سعر الوحدة</h3>
                        <div class="value" id="displayPrice">10,000,000 ج.م</div>
                    </div>
                    <div class="card">
                        <h3>المقدم (10%)</h3>
                        <div class="value" id="downPayment">1,000,000 ج.م</div>
                    </div>
                    <div class="card">
                        <h3>المبلغ بعد المقدم</h3>
                        <div class="value" id="afterDown">9,000,000 ج.م</div>
                    </div>
                </div>
            </div>
            
            <!-- Sheet 2: الخطة الافتراضية -->
            <div id="sheet2" class="sheet">
                <div class="input-section">
                    <h2 style="margin-bottom: 20px; color: #495057;">📋 جدول السداد الافتراضي</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>عدد السنين</label>
                            <input type="number" id="defaultYears" value="6" min="1" max="15" oninput="calculate()">
                        </div>
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="card">
                        <h3>إجمالي المبلغ</h3>
                        <div class="value" id="defaultTotal">10,000,000 ج.م</div>
                        <small style="opacity: 0.8; font-size: 12px;">ثابت عند سعر الوحدة</small>
                    </div>
                    <div class="card">
                        <h3>عدد الأقساط</h3>
                        <div class="value" id="defaultInstallmentsCount">24 قسط</div>
                    </div>
                    <div class="card">
                        <h3>المدة الكلية</h3>
                        <div class="value" id="defaultDuration">6 سنوات</div>
                    </div>
                </div>
                
                <div id="warningMessageDefault" class="warning-message">
                    ⚠️ تحذير: إجمالي النسب تجاوز 100%! الرجاء مراجعة الأقساط
                </div>
                
                <div class="table-container">
                    <table id="defaultTable">
                        <thead>
                            <tr>
                                <th>رقم القسط</th>
                                <th>النوع</th>
                                <th>التاريخ</th>
                                <th>النسبة %</th>
                                <th>المبلغ (ج.م)</th>
                                <th>المتبقي (ج.م)</th>
                            </tr>
                        </thead>
                        <tbody id="defaultTableBody">
                        </tbody>
                    </table>
                </div>
                
                <button class="btn" onclick="exportToExcel('default')">📥 تصدير لملف Excel</button>
            </div>
            
            <!-- Sheet 3: الخطة المخصصة -->
            <div id="sheet3" class="sheet">
                <div class="input-section">
                    <h2 style="margin-bottom: 20px; color: #495057;">⚙️ إعدادات الخطة المخصصة</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>عدد السنين</label>
                            <input type="number" id="customYears" value="6" min="1" max="15" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label>نوع الخطة</label>
                            <select id="planType" onchange="calculate()">
                                <option value="custom">خطة مخصصة</option>
                                <option value="cash">دفع كاش (خصم 30%)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="card">
                        <h3>إجمالي المبلغ</h3>
                        <div class="value" id="customTotal">10,000,000 ج.م</div>
                    </div>
                    <div class="card">
                        <h3>الفرق عن الخطة الافتراضية</h3>
                        <div class="value" id="customDiff">0 ج.م</div>
                    </div>
                    <div class="card">
                        <h3>نوع الفرق</h3>
                        <div class="value" id="customDiffType">-</div>
                    </div>
                </div>
                
                <div id="warningMessage" class="warning-message">
                    ⚠️ تحذير: إجمالي النسب تجاوز 100%! الرجاء مراجعة الأقساط
                </div>
                
                <div id="customTableContainer" class="table-container" style="margin-top: 20px;">
                    <table id="customTable">
                        <thead>
                            <tr>
                                <th>رقم القسط</th>
                                <th>التاريخ</th>
                                <th>النسبة %</th>
                                <th>المبلغ (ج.م)</th>
                                <th>المتبقي (ج.م)</th>
                            </tr>
                        </thead>
                        <tbody id="customTableBody">
                        </tbody>
                    </table>
                </div>
                
                <button class="btn" onclick="exportToExcel('custom')">📥 تصدير لملف Excel</button>
            </div>
            
            <!-- Sheet 4: المقارنات -->
            <div id="sheet4" class="sheet">
                <h2 style="margin-bottom: 20px; color: #495057;">📊 مقارنة الخطط</h2>
                
                <div class="table-container comparison-table">
                    <table>
                        <thead>
                            <tr>
                                <th>نوع الخطة</th>
                                <th>المدة</th>
                                <th>إجمالي المبلغ (ج.م)</th>
                                <th>الفرق عن السعر الأساسي</th>
                                <th>التوفير/الزيادة</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // تعيين التاريخ الحالي كافتراضي
        document.getElementById('startDate').valueAsDate = new Date();
        
        // لتتبع الأقساط المعدلة يدوياً
        let manuallyEditedRows = new Set();
        let manuallyEditedDefaultRows = new Set();
        
        // تخزين القيم المعدلة
        let savedDefaultValues = {};
        let savedCustomValues = {};
        
        // تخزين الإجماليات الفعلية
        let actualDefaultTotal = 0;
        let actualCustomTotal = 0;
        
        function showSheet(num) {
            // إخفاء كل الشيتات
            document.querySelectorAll('.sheet').forEach(sheet => {
                sheet.classList.remove('active');
            });
            
            // إخفاء كل التابات
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إظهار الشيت والتاب المحددين
            document.getElementById('sheet' + num).classList.add('active');
            document.querySelectorAll('.tab')[num - 1].classList.add('active');
        }
        
        function formatCurrency(num) {
            return new Intl.NumberFormat('ar-EG').format(Math.round(num));
        }
        
        function formatDate(date) {
            return new Intl.DateTimeFormat('ar-EG', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).format(date);
        }
        
        function addMonths(date, months) {
            const result = new Date(date);
            result.setMonth(result.getMonth() + months);
            return result;
        }
        
        function calculate() {
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            let interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            let discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
            // Clamp rates to [0, 100]
            interestRate = Math.min(100, Math.max(0, interestRate));
            discountRate = Math.min(100, Math.max(0, discountRate));
            const startDate = new Date(document.getElementById('startDate').value);
            const customYears = parseFloat(document.getElementById('customYears').value) || 6;
            const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
            const planType = document.getElementById('planType').value;
            
            // تحديث البيانات الأساسية
            document.getElementById('displayPrice').textContent = formatCurrency(unitPrice) + ' ج.م';
            document.getElementById('downPayment').textContent = formatCurrency(unitPrice * 0.1) + ' ج.م';
            document.getElementById('afterDown').textContent = formatCurrency(unitPrice * 0.9) + ' ج.م';
            
            // حساب الخطة الافتراضية
            calculateDefaultPlan(unitPrice, defaultYears, startDate);
            
            // حساب الخطة المخصصة
            if (planType === 'cash') {
                calculateCashPlan(unitPrice);
            } else {
                calculateCustomPlan(unitPrice, customYears, interestRate, discountRate, startDate);
            }
            
            // تحديث المقارنات
            updateComparison(unitPrice, defaultYears, customYears, interestRate, discountRate);
        }
        
        function calculateDefaultPlan(unitPrice, years, startDate) {
            const tbody = document.getElementById('defaultTableBody');
            const totalInstallments = years * 4;
            
            // فحص إذا تغيرت البارامترات (عدد السنين)
            const planKey = `default_${years}`;
            if (!savedDefaultValues[planKey]) {
                // خطة جديدة - مسح التعديلات القديمة
                manuallyEditedDefaultRows.clear();
                savedDefaultValues = {};
                savedDefaultValues[planKey] = {};
            }
            
            tbody.innerHTML = '';
            
            let remaining = unitPrice;
            let currentDate = new Date(startDate);
            
            // تحديث عدد الأقساط والمدة
            document.getElementById('defaultInstallmentsCount').textContent = totalInstallments + ' قسط';
            document.getElementById('defaultDuration').textContent = years + ' سنوات';
            
            // المقدم
            const downPaymentPercentage = savedDefaultValues[planKey][0] || 10;
            const downPayment = unitPrice * (downPaymentPercentage / 100);
            remaining -= downPayment;
            tbody.innerHTML += `
                <tr class="highlight">
                    <td>0</td>
                    <td><strong>مقدم</strong></td>
                    <td>${formatDate(currentDate)}</td>
                    <td class="editable-cell">
                        <input type="number" step="0.01" min="0" max="100" value="${downPaymentPercentage.toFixed(2)}" 
                               onchange="saveAndUpdateDefaultInstallment(0, ${unitPrice}, '${planKey}')" 
                               data-row="0">
                    </td>
                    <td class="number">${formatCurrency(downPayment)}</td>
                    <td class="number">${formatCurrency(remaining)}</td>
                </tr>
            `;
            
            // باقي الأقساط - توزيع متساوي أو القيم المحفوظة
            const remainingPercentage = 90; // 100% - 10% مقدم
            const installmentPercentage = remainingPercentage / totalInstallments;
            
            for (let i = 1; i <= totalInstallments; i++) {
                currentDate = addMonths(currentDate, 3);
                const percentage = savedDefaultValues[planKey][i] || installmentPercentage;
                const installmentAmount = unitPrice * (percentage / 100);
                remaining -= installmentAmount;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${i}</td>
                        <td>قسط</td>
                        <td>${formatDate(currentDate)}</td>
                        <td class="editable-cell">
                            <input type="number" step="0.01" min="0" max="100" value="${percentage.toFixed(2)}" 
                                   onchange="saveAndUpdateDefaultInstallment(${i}, ${unitPrice}, '${planKey}')" 
                                   data-row="${i}">
                        </td>
                        <td class="number">${formatCurrency(installmentAmount)}</td>
                        <td class="number">${formatCurrency(Math.max(0, remaining))}</td>
                    </tr>
                `;
            }
            
            // الخطة الافتراضية دائماً = سعر الوحدة الأساسي (ثابت)
            actualDefaultTotal = unitPrice;
            document.getElementById('defaultTotal').textContent = formatCurrency(unitPrice) + ' ج.م';
            
            validateDefaultTotalPercentage();
            
            // تحديث المقارنات بعد تحميل الخطة
            setTimeout(() => {
                const customYears = parseFloat(document.getElementById('customYears').value) || 6;
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                updateComparison(unitPrice, years, customYears, interestRate, discountRate);
            }, 0);
        }
        
        function saveAndUpdateDefaultInstallment(rowIndex, total, planKey) {
            updateDefaultInstallment(rowIndex, total);
            
            // حفظ القيم المعدلة
            const tbody = document.getElementById('defaultTableBody');
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row) => {
                const input = row.querySelector('input');
                if (input) {
                    const rowNum = parseInt(input.getAttribute('data-row'));
                    savedDefaultValues[planKey][rowNum] = parseFloat(input.value) || 0;
                }
            });
        }
        
        function updateDefaultInstallment(rowIndex, total) {
            // إضافة القسط للأقساط المعدلة يدوياً
            manuallyEditedDefaultRows.add(rowIndex);
            
            const tbody = document.getElementById('defaultTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            // جمع النسب المثبتة (الأقساط المعدلة يدوياً)
            let fixedPercentages = 0;
            let flexibleRows = [];
            
            rows.forEach((row, index) => {
                const percentageInput = row.querySelector('input');
                const rowNum = parseInt(percentageInput.getAttribute('data-row'));
                
                if (manuallyEditedDefaultRows.has(rowNum)) {
                    // أقساط معدلة يدوياً - نسب ثابتة
                    fixedPercentages += parseFloat(percentageInput.value) || 0;
                } else {
                    // باقي الأقساط - ستتوزع عليها النسبة المتبقية
                    flexibleRows.push(row);
                }
            });
            
            // حساب النسبة المتبقية للتوزيع
            const remainingPercentage = 100 - fixedPercentages;
            
            // توزيع النسبة المتبقية على الأقساط المرنة
            if (flexibleRows.length > 0) {
                if (remainingPercentage >= 0) {
                    const percentagePerInstallment = remainingPercentage / flexibleRows.length;
                    
                    flexibleRows.forEach(row => {
                        const percentageInput = row.querySelector('input');
                        percentageInput.value = percentagePerInstallment.toFixed(2);
                    });
                } else {
                    // إظهار رسالة تحذير
                    document.getElementById('warningMessageDefault').style.display = 'block';
                    document.getElementById('warningMessageDefault').textContent = 
                        `⚠️ تحذير: الأقساط المعدلة تجاوزت 100%! يرجى تقليل النسب`;
                }
            }
            
            // إعادة حساب كل الأقساط
            let remaining = total;
            
            rows.forEach((row, index) => {
                const percentageInput = row.querySelector('input');
                const percentage = parseFloat(percentageInput.value) || 0;
                const amount = total * (percentage / 100);
                
                remaining -= amount;
                
                // تحديث المبلغ
                const amountCell = row.querySelectorAll('td')[4];
                amountCell.innerHTML = formatCurrency(amount);
                amountCell.classList.add('number');
                
                // تحديث المتبقي
                const remainingCell = row.querySelectorAll('td')[5];
                remainingCell.innerHTML = formatCurrency(Math.max(0, remaining));
                remainingCell.classList.add('number');
            });
            
            validateDefaultTotalPercentage();
            updateDefaultTotal(total);
            
            // حفظ جميع القيم بعد التحديث
            const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
            const planKey = `default_${defaultYears}`;
            rows.forEach((row) => {
                const input = row.querySelector('input');
                if (input) {
                    const rowNum = parseInt(input.getAttribute('data-row'));
                    savedDefaultValues[planKey][rowNum] = parseFloat(input.value) || 0;
                }
            });
        }
        
        function validateDefaultTotalPercentage() {
            const tbody = document.getElementById('defaultTableBody');
            const inputs = tbody.querySelectorAll('input[type="number"]');
            
            let totalPercentage = 0;
            inputs.forEach(input => {
                totalPercentage += parseFloat(input.value) || 0;
            });
            
            const warningMessage = document.getElementById('warningMessageDefault');
            if (Math.abs(totalPercentage - 100) > 0.1) {
                if (totalPercentage > 100) {
                    warningMessage.style.display = 'block';
                    warningMessage.textContent = `⚠️ تحذير: إجمالي النسب ${totalPercentage.toFixed(2)}% تجاوز 100%!`;
                } else {
                    warningMessage.style.display = 'block';
                    warningMessage.textContent = `ℹ️ ملاحظة: إجمالي النسب ${totalPercentage.toFixed(2)}% - المبلغ الإجمالي ثابت عند سعر الوحدة`;
                    warningMessage.style.background = '#17a2b8';
                }
            } else {
                warningMessage.style.display = 'none';
            }
            
            return totalPercentage;
        }
        
        function updateDefaultTotal(baseTotal) {
            validateDefaultTotalPercentage();
            
            // الخطة الافتراضية دائماً = سعر الوحدة الأساسي (ثابت)
            actualDefaultTotal = baseTotal;
            document.getElementById('defaultTotal').textContent = formatCurrency(actualDefaultTotal) + ' ج.م';
            
            // إعادة حساب الخطة المخصصة بناءً على التعديلات في الخطة الافتراضية
            try {
                const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
                const customYears = parseFloat(document.getElementById('customYears').value) || 6;
                const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
                const startDate = new Date(document.getElementById('startDate').value);
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                
                // إعادة حساب الخطة المخصصة
                const customYearsVal = parseFloat(document.getElementById('customYears').value) || 6;
                const yearsDiff = customYearsVal - defaultYears;
                let customBaseTotal = unitPrice;
                
                if (yearsDiff > 0) {
                    const r = (interestRate || 0) / 100;
                    customBaseTotal = unitPrice * Math.pow(1 + r, yearsDiff);
                } else if (yearsDiff < 0) {
                    const d = (discountRate || 0) / 100;
                    customBaseTotal = unitPrice / Math.pow(1 + d, Math.abs(yearsDiff));
                }
                
                const defaultFlows = buildDefaultPlanFlowsFromTable(defaultYears, startDate);
                const customFlows = buildCustomPlanFlowsFromTable(customYearsVal, startDate);
                const timingAdjustment = computeTimingAdjustment(unitPrice, defaultFlows, customFlows, interestRate, discountRate);
                
                actualCustomTotal = customBaseTotal + timingAdjustment;
                document.getElementById('customTotal').textContent = formatCurrency(actualCustomTotal) + ' ج.م';
                
                const diff = actualCustomTotal - actualDefaultTotal;
                document.getElementById('customDiff').textContent = formatCurrency(Math.abs(diff)) + ' ج.م';
                if (diff > 0) {
                    document.getElementById('customDiffType').textContent = 'زيادة عن الافتراضية';
                    document.getElementById('customDiffType').style.color = '#dc3545';
                } else if (diff < 0) {
                    document.getElementById('customDiffType').textContent = 'توفير عن الافتراضية';
                    document.getElementById('customDiffType').style.color = '#28a745';
                } else {
                    document.getElementById('customDiffType').textContent = 'نفس الخطة الافتراضية';
                    document.getElementById('customDiffType').style.color = '#667eea';
                }
            } catch (e) {
                console.warn('Custom plan update skipped:', e);
            }
            
            // تحديث المقارنات عند التعديل على الخطة الافتراضية
            setTimeout(() => {
                const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
                const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
                const customYears = parseFloat(document.getElementById('customYears').value) || 6;
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                updateComparison(unitPrice, defaultYears, customYears, interestRate, discountRate);
            }, 0);
        }
        
        function calculateCashPlan(unitPrice) {
            const cashAmount = unitPrice * 0.7;
            actualCustomTotal = cashAmount;
            document.getElementById('customTotal').textContent = formatCurrency(cashAmount) + ' ج.م';
            
            const diff = cashAmount - actualDefaultTotal;
            document.getElementById('customDiff').textContent = formatCurrency(Math.abs(diff)) + ' ج.م';
            document.getElementById('customDiffType').textContent = 'توفير (خصم 30%)';
            document.getElementById('customDiffType').style.color = '#28a745';
            
            const tbody = document.getElementById('customTableBody');
            tbody.innerHTML = `
                <tr class="highlight">
                    <td>0</td>
                    <td>${formatDate(new Date())}</td>
                    <td>70.00%</td>
                    <td class="number">${formatCurrency(cashAmount)}</td>
                    <td class="number">0</td>
                </tr>
            `;
            
            // إخفاء رسالة التحذير للدفع الكاش
            document.getElementById('warningMessage').style.display = 'none';
            document.getElementById('customTableContainer').style.display = 'block';
        }
        
        function calculateCustomPlan(unitPrice, customYears, interestRate, discountRate, startDate) {
            const totalInstallments = customYears * 4;
            
            // فحص إذا تغيرت البارامترات
            const planKey = `custom_${customYears}`;
            if (!savedCustomValues[planKey]) {
                // خطة جديدة - مسح التعديلات القديمة
                manuallyEditedRows.clear();
                savedCustomValues = {};
                savedCustomValues[planKey] = {};
            }
            
            // المقارنة مع عدد سنين الخطة الافتراضية
            const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
            const yearsDiff = customYears - defaultYears;
            let total = unitPrice;
            let diffAmount = 0;
            let diffType = '';
            
            if (yearsDiff > 0) {
                // فوائد مركبة سنوية: إجمالي = السعر الأساسي * (1 + r)^n
                const r = (interestRate || 0) / 100;
                total = unitPrice * Math.pow(1 + r, yearsDiff);
                diffAmount = total - unitPrice;
                diffType = `فوائد مركبة (${yearsDiff} سنة إضافية)`;
                document.getElementById('customDiffType').style.color = '#dc3545';
            } else if (yearsDiff < 0) {
                // خصم مركب سنوي: إجمالي = السعر الأساسي / (1 + d)^n
                const d = (discountRate || 0) / 100;
                total = unitPrice / Math.pow(1 + d, Math.abs(yearsDiff));
                diffAmount = unitPrice - total;
                diffType = `خصم مركب (${Math.abs(yearsDiff)} سنة مبكرة)`;
                document.getElementById('customDiffType').style.color = '#28a745';
            } else {
                diffType = 'نفس الخطة الافتراضية';
                document.getElementById('customDiffType').style.color = '#667eea';
            }
            
            actualCustomTotal = total;
            document.getElementById('customTotal').textContent = formatCurrency(total) + ' ج.م';
            
            // المقارنة مع الخطة الافتراضية
            const actualDiff = actualCustomTotal - actualDefaultTotal;
            
            document.getElementById('customDiff').textContent = formatCurrency(Math.abs(actualDiff)) + ' ج.م';
            
            if (actualDiff > 0) {
                document.getElementById('customDiffType').textContent = 'زيادة عن الافتراضية';
                document.getElementById('customDiffType').style.color = '#dc3545';
            } else if (actualDiff < 0) {
                document.getElementById('customDiffType').textContent = 'توفير عن الافتراضية';
                document.getElementById('customDiffType').style.color = '#28a745';
            } else {
                document.getElementById('customDiffType').textContent = 'نفس الخطة الافتراضية';
                document.getElementById('customDiffType').style.color = '#667eea';
            }
            
            // حساب الأقساط
            const tbody = document.getElementById('customTableBody');
            tbody.innerHTML = '';
            
            let remaining = total;
            let currentDate = new Date(startDate);
            
            // المقدم - استخدام القيمة المحفوظة أو الافتراضية (10%)
            const downPercent = (savedCustomValues[planKey] && savedCustomValues[planKey][0] != null)
                ? (parseFloat(savedCustomValues[planKey][0]) || 10) : 10;
            
            const downPayment = total * (downPercent / 100);
            remaining -= downPayment;
            tbody.innerHTML += `
                <tr class="highlight">
                    <td>0</td>
                    <td>${formatDate(currentDate)}</td>
                    <td class="editable-cell">
                        <input type="number" step="0.01" min="0" max="100" value="${downPercent.toFixed(2)}" 
                               onchange="saveAndUpdateInstallment(0, ${total}, '${planKey}')" 
                               data-row="0">
                    </td>
                    <td class="number">${formatCurrency(downPayment)}</td>
                    <td class="number">${formatCurrency(remaining)}</td>
                </tr>
            `;
            
            // حساب الأقساط بناءً على عدد السنين - توزيع متساوي للباقي
            const remainingPercent = 100 - downPercent;
            const installmentPercent = remainingPercent / totalInstallments;
            
            for (let i = 1; i <= totalInstallments; i++) {
                currentDate = addMonths(currentDate, 3);
                const percentage = (savedCustomValues[planKey] && savedCustomValues[planKey][i] != null)
                    ? (parseFloat(savedCustomValues[planKey][i]) || 0)
                    : installmentPercent;
                const amount = total * (percentage / 100);
                remaining -= amount;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${i}</td>
                        <td>${formatDate(currentDate)}</td>
                        <td class="editable-cell">
                            <input type="number" step="0.01" min="0" max="100" value="${percentage.toFixed(2)}" 
                                   onchange="saveAndUpdateInstallment(${i}, ${total}, '${planKey}')" 
                                   data-row="${i}">
                        </td>
                        <td class="number">${formatCurrency(amount)}</td>
                        <td class="number">${formatCurrency(Math.max(0, remaining))}</td>
                    </tr>
                `;
            }
            
            document.getElementById('customTableContainer').style.display = 'block';
            
            // تطبيق خصم/فوائد بناءً على تقديم/تأخير السداد مقارنة بالجدول الافتراضي
            try {
                // قراءة القيم الفعلية من الجداول بعد إنشائها
                const defaultFlows = buildDefaultPlanFlowsFromTable(defaultYears, startDate);
                const customFlows = buildCustomPlanFlowsFromTable(customYears, startDate);
                const timingAdjustment = computeTimingAdjustment(unitPrice, defaultFlows, customFlows, interestRate, discountRate);

                actualCustomTotal = total + timingAdjustment;
                document.getElementById('customTotal').textContent = formatCurrency(actualCustomTotal) + ' ج.م';

                const updatedDiff = actualCustomTotal - actualDefaultTotal;
                document.getElementById('customDiff').textContent = formatCurrency(Math.abs(updatedDiff)) + ' ج.م';
                if (updatedDiff > 0) {
                    document.getElementById('customDiffType').textContent = 'زيادة عن الافتراضية';
                    document.getElementById('customDiffType').style.color = '#dc3545';
                } else if (updatedDiff < 0) {
                    document.getElementById('customDiffType').textContent = 'توفير عن الافتراضية';
                    document.getElementById('customDiffType').style.color = '#28a745';
                } else {
                    document.getElementById('customDiffType').textContent = 'نفس الخطة الافتراضية';
                    document.getElementById('customDiffType').style.color = '#667eea';
                }
            } catch (e) {
                console.warn('Timing adjustment skipped:', e);
            }
            
            validateTotalPercentage();
            
            // تحديث المقارنات بعد تحميل الخطة
            setTimeout(() => {
                const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                updateComparison(unitPrice, defaultYears, customYears, interestRate, discountRate);
            }, 0);
        }

        // يبني تدفقات الخطة الافتراضية من الجدول الفعلي: مصفوفة من { date, percent }
        function buildDefaultPlanFlowsFromTable(years, startDate) {
            const flows = [];
            const tbody = document.getElementById('defaultTableBody');
            const rows = tbody.querySelectorAll('tr');
            let currentDate = new Date(startDate);
            
            rows.forEach((row, index) => {
                const input = row.querySelector('input[type="number"]');
                if (input) {
                    const percent = parseFloat(input.value) || 0;
                    flows.push({ date: new Date(currentDate), percent: percent });
                    // كل قسط بعد 3 أشهر
                    if (index < rows.length - 1) {
                        currentDate = addMonths(currentDate, 3);
                    }
                }
            });
            
            return flows;
        }

        // يبني تدفقات الخطة المخصصة من الجدول الفعلي: مصفوفة من { date, percent }
        function buildCustomPlanFlowsFromTable(years, startDate) {
            const flows = [];
            const tbody = document.getElementById('customTableBody');
            const rows = tbody.querySelectorAll('tr');
            let currentDate = new Date(startDate);
            
            rows.forEach((row, index) => {
                const input = row.querySelector('input[type="number"]');
                if (input) {
                    const percent = parseFloat(input.value) || 0;
                    flows.push({ date: new Date(currentDate), percent: percent });
                    // كل قسط بعد 3 أشهر
                    if (index < rows.length - 1) {
                        currentDate = addMonths(currentDate, 3);
                    }
                }
            });
            
            return flows;
        }

        // يحسب فرق القيمة الزمنية: خصم للتقديم باستخدام discountRate، وفوائد للتأخير باستخدام interestRate
        function computeTimingAdjustment(unitPrice, defaultFlows, customFlows, interestRate, discountRate) {
            let i = 0, j = 0;
            let remDef = defaultFlows.length ? (defaultFlows[0].percent || 0) : 0;
            let remCus = customFlows.length ? (customFlows[0].percent || 0) : 0;
            let adjustment = 0; // موجب = زيادة، سالب = خصم
            const r = Math.max(0, (interestRate || 0) / 100);
            const d = Math.max(0, (discountRate || 0) / 100);

            const toYears = (from, to) => Math.max(0, (to.getTime() - from.getTime()) / (365.25 * 24 * 3600 * 1000));

            while (i < defaultFlows.length && j < customFlows.length) {
                const def = defaultFlows[i];
                const cus = customFlows[j];
                const move = Math.min(remDef, remCus);

                if (move > 0) {
                    if (cus.date < def.date) {
                        // تقديم سداد: خصم
                        const t = toYears(cus.date, def.date);
                        const discount = unitPrice * (move / 100) * (1 - 1 / Math.pow(1 + d, t));
                        adjustment -= discount;
                    } else if (cus.date > def.date) {
                        // تأخير سداد: فوائد
                        const t = toYears(def.date, cus.date);
                        const surcharge = unitPrice * (move / 100) * (Math.pow(1 + r, t) - 1);
                        adjustment += surcharge;
                    }
                }

                remDef -= move;
                remCus -= move;
                if (remDef <= 1e-9) {
                    i++;
                    remDef = i < defaultFlows.length ? (defaultFlows[i].percent || 0) : 0;
                }
                if (remCus <= 1e-9) {
                    j++;
                    remCus = j < customFlows.length ? (customFlows[j].percent || 0) : 0;
                }
            }

            return adjustment;
        }
        
        function saveAndUpdateInstallment(rowIndex, total, planKey) {
            updateInstallment(rowIndex, total);
            
            // حفظ القيم المعدلة
            const tbody = document.getElementById('customTableBody');
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row) => {
                const input = row.querySelector('input');
                if (input) {
                    const rowNum = parseInt(input.getAttribute('data-row'));
                    savedCustomValues[planKey][rowNum] = parseFloat(input.value) || 0;
                }
            });
        }
        
        function updateInstallment(rowIndex, total) {
            // إضافة القسط للأقساط المعدلة يدوياً
            manuallyEditedRows.add(rowIndex);
            
            const tbody = document.getElementById('customTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            // جمع النسب المثبتة (الأقساط المعدلة يدوياً)
            let fixedPercentages = 0;
            let flexibleRows = [];
            
            rows.forEach((row, index) => {
                const percentageInput = row.querySelector('input');
                const rowNum = parseInt(percentageInput.getAttribute('data-row'));
                
                if (manuallyEditedRows.has(rowNum)) {
                    // أقساط معدلة يدوياً - نسب ثابتة
                    fixedPercentages += parseFloat(percentageInput.value) || 0;
                } else {
                    // باقي الأقساط - ستتوزع عليها النسبة المتبقية
                    flexibleRows.push(row);
                }
            });
            
            // حساب النسبة المتبقية للتوزيع
            const remainingPercentage = 100 - fixedPercentages;
            
            // توزيع النسبة المتبقية على الأقساط المرنة
            if (flexibleRows.length > 0) {
                if (remainingPercentage >= 0) {
                    const percentagePerInstallment = remainingPercentage / flexibleRows.length;
                    
                    flexibleRows.forEach(row => {
                        const percentageInput = row.querySelector('input');
                        percentageInput.value = percentagePerInstallment.toFixed(2);
                    });
                } else {
                    // إظهار رسالة تحذير
                    document.getElementById('warningMessage').style.display = 'block';
                    document.getElementById('warningMessage').textContent = 
                        `⚠️ تحذير: الأقساط المعدلة تجاوزت 100%! يرجى تقليل النسب`;
                }
            }
            
            // إعادة حساب كل الأقساط
            let remaining = total;
            
            rows.forEach((row, index) => {
                const percentageInput = row.querySelector('input');
                const percentage = parseFloat(percentageInput.value) || 0;
                const amount = total * (percentage / 100);
                
                remaining -= amount;
                
                // تحديث المبلغ
                const amountCell = row.querySelectorAll('td')[3];
                amountCell.innerHTML = formatCurrency(amount);
                amountCell.classList.add('number');
                
                // تحديث المتبقي
                const remainingCell = row.querySelectorAll('td')[4];
                remainingCell.innerHTML = formatCurrency(Math.max(0, remaining));
                remainingCell.classList.add('number');
            });
            
            validateTotalPercentage();
            updateCustomTotal(total);
            
            // حفظ جميع القيم بعد التحديث
            const customYears = parseFloat(document.getElementById('customYears').value) || 6;
            const planKey = `custom_${customYears}`;
            rows.forEach((row) => {
                const input = row.querySelector('input');
                if (input) {
                    const rowNum = parseInt(input.getAttribute('data-row'));
                    savedCustomValues[planKey][rowNum] = parseFloat(input.value) || 0;
                }
            });
        }
        
        function validateTotalPercentage() {
            const tbody = document.getElementById('customTableBody');
            const inputs = tbody.querySelectorAll('input[type="number"]');
            
            let totalPercentage = 0;
            inputs.forEach(input => {
                totalPercentage += parseFloat(input.value) || 0;
            });
            
            // إخفاء رسالة التحذير عند التوزيع التلقائي
            const warningMessage = document.getElementById('warningMessage');
            if (Math.abs(totalPercentage - 100) > 0.1 && totalPercentage > 100) {
                // رسالة تحذير فقط إذا كانت النسبة أكبر من 100 بشكل ملحوظ
                warningMessage.style.display = 'block';
                warningMessage.textContent = `⚠️ تحذير: إجمالي النسب ${totalPercentage.toFixed(2)}% تجاوز 100%!`;
            } else {
                warningMessage.style.display = 'none';
            }
            
            return totalPercentage;
        }
        
        function updateCustomTotal(baseTotal) {
            const totalPercentage = validateTotalPercentage();
            let calculatedTotal = baseTotal * (totalPercentage / 100);
            
            // إعادة حساب timing adjustment بعد التعديل اليدوي
            try {
                const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
                const customYears = parseFloat(document.getElementById('customYears').value) || 6;
                const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
                const startDate = new Date(document.getElementById('startDate').value);
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                
                const defaultFlows = buildDefaultPlanFlowsFromTable(defaultYears, startDate);
                const customFlows = buildCustomPlanFlowsFromTable(customYears, startDate);
                const timingAdjustment = computeTimingAdjustment(unitPrice, defaultFlows, customFlows, interestRate, discountRate);
                
                actualCustomTotal = calculatedTotal + timingAdjustment;
            } catch (e) {
                console.warn('Timing adjustment skipped in updateCustomTotal:', e);
                actualCustomTotal = calculatedTotal;
            }
            
            document.getElementById('customTotal').textContent = formatCurrency(actualCustomTotal) + ' ج.م';
            
            // المقارنة مع الخطة الافتراضية
            const diff = actualCustomTotal - actualDefaultTotal;
            
            document.getElementById('customDiff').textContent = formatCurrency(Math.abs(diff)) + ' ج.م';
            
            if (diff > 0) {
                document.getElementById('customDiffType').textContent = 'زيادة';
                document.getElementById('customDiffType').style.color = '#dc3545';
            } else if (diff < 0) {
                document.getElementById('customDiffType').textContent = 'توفير';
                document.getElementById('customDiffType').style.color = '#28a745';
            } else {
                document.getElementById('customDiffType').textContent = 'نفس السعر';
                document.getElementById('customDiffType').style.color = '#667eea';
            }
            
            // تحديث المقارنات
            setTimeout(() => {
                const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
                const defaultYears = parseFloat(document.getElementById('defaultYears').value) || 6;
                const customYears = parseFloat(document.getElementById('customYears').value) || 6;
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
                updateComparison(unitPrice, defaultYears, customYears, interestRate, discountRate);
            }, 0);
        }
        
        function updateComparison(unitPrice, defaultYears, customYears, interestRate, discountRate) {
            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';
            
            // استخدام القيم الفعلية المخزنة
            const defaultTotal = actualDefaultTotal || unitPrice;
            const customTotal = actualCustomTotal || unitPrice;
            
            // الخطة الافتراضية
            const defaultInstallments = defaultYears * 4;
            tbody.innerHTML += `
                <tr>
                    <td><strong>الخطة الافتراضية</strong></td>
                    <td>${defaultYears} سنة (${defaultInstallments} قسط)</td>
                    <td class="number">${formatCurrency(defaultTotal)}</td>
                    <td class="number">-</td>
                    <td>خطة أساسية</td>
                </tr>
            `;
            
            // الخطة المخصصة
            const customInstallments = customYears * 4;
            const diff = customTotal - defaultTotal;
            let diffText = '';
            let savingsClass = '';
            let diffType = '';
            
            if (diff > 0) {
                diffText = `+${formatCurrency(diff)}`;
                savingsClass = 'additional';
                diffType = 'زيادة';
            } else if (diff < 0) {
                diffText = `-${formatCurrency(Math.abs(diff))}`;
                savingsClass = 'savings';
                diffType = 'توفير';
            } else {
                diffText = '0';
                diffType = 'نفس المبلغ';
            }
            
            tbody.innerHTML += `
                <tr>
                    <td><strong>الخطة المخصصة</strong></td>
                    <td>${customYears} سنة (${customInstallments} قسط)</td>
                    <td class="number">${formatCurrency(customTotal)}</td>
                    <td class="number ${savingsClass}">${diffText}</td>
                    <td>${diffType}</td>
                </tr>
            `;
            
            // الدفع الكاش
            const cashTotal = unitPrice * 0.7;
            const cashDiff = cashTotal - defaultTotal;
            const cashDiffText = cashDiff < 0 ? `-${formatCurrency(Math.abs(cashDiff))}` : `+${formatCurrency(cashDiff)}`;
            tbody.innerHTML += `
                <tr>
                    <td><strong>دفع كاش</strong></td>
                    <td>دفعة واحدة</td>
                    <td class="number">${formatCurrency(cashTotal)}</td>
                    <td class="number savings">${cashDiffText}</td>
                    <td>خصم 30% من السعر الأساسي</td>
                </tr>
            `;
        }
        
        function exportToExcel(type) {
            let csv = '\ufeff'; // BOM for UTF-8
            
            if (type === 'default') {
                csv += 'رقم القسط,النوع,التاريخ,النسبة %,المبلغ (ج.م),المتبقي (ج.م)\n';
                const tbody = document.getElementById('defaultTableBody');
                const rows = tbody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const cols = row.querySelectorAll('td');
                    const rowData = [];
                    cols.forEach((col, index) => {
                        // للعمود الرابع (النسبة) نستخرج القيمة من الـ input
                        if (index === 3) {
                            const input = col.querySelector('input');
                            if (input) {
                                rowData.push(input.value + '%');
                            } else {
                                rowData.push(col.textContent.trim());
                            }
                        } else {
                            rowData.push(col.textContent.trim());
                        }
                    });
                    csv += rowData.join(',') + '\n';
                });
            } else if (type === 'custom') {
                csv += 'رقم القسط,التاريخ,النسبة %,المبلغ (ج.م),المتبقي (ج.م)\n';
                const tbody = document.getElementById('customTableBody');
                const rows = tbody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const cols = row.querySelectorAll('td');
                    const rowData = [];
                    cols.forEach((col, index) => {
                        // للعمود الثالث (النسبة) نستخرج القيمة من الـ input
                        if (index === 2) {
                            const input = col.querySelector('input');
                            if (input) {
                                rowData.push(input.value + '%');
                            } else {
                                rowData.push(col.textContent.trim());
                            }
                        } else {
                            rowData.push(col.textContent.trim());
                        }
                    });
                    csv += rowData.join(',') + '\n';
                });
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `payment_plan_${type}_${Date.now()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // الحساب الأولي
        calculate();
    </script>
</body>
</html>
